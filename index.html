<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <base href="/Gift-Tower/">

  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />

  <title>Holly Polly — Башня</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --page-bg:#ff4da6;
      --field-bg:#9b98e5;
      --control-green:#2e8b57;
      --btn-color:#fff;
      --lb-yellow:#ffe84a;
    }

    html,body{
      height:100%;
      margin:0;
      overflow:hidden;
      background:var(--page-bg);
      font-family:Futura,Arial,sans-serif;
    }

    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:12px;
      box-sizing:border-box;
    }

    header{
      text-align:center;
      margin-bottom:6px;
      user-select:none;
    }

    header img{
      max-height:64px;
      display:block;
      margin:0 auto;
    }

    header .slogan{
      font-weight:700;
      font-size:0.9em;
      margin-top:4px;
    }

    #container{
      background:var(--field-bg);
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
      position:relative;
    }

    canvas{
      display:block;
    }

    .loader{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.45);
      z-index:10;
    }

    .bar{
      width:60%;
      height:8px;
      background:rgba(255,255,255,.4);
      border-radius:999px;
      overflow:hidden;
    }

    .bar > div{
      height:100%;
      width:0%;
      background:var(--control-green);
      transition:width .15s linear;
    }
  </style>
</head>

<body>

<header>
  <img src="logo.png" alt="logo">
  <div class="slogan">Holly Polly — твоя лучшая подруга!</div>
</header>

<div id="container">
  <canvas id="game"></canvas>

  <div id="loader" class="loader">
    <div class="bar">
      <div id="barFill"></div>
    </div>
  </div>
</div>

<script>
/* =====================================================
   CONFIG
   ===================================================== */
const CAMERA_SCALE = 0.73;
const MANIFEST_URL = 'asset-manifest.json';

/* =====================================================
   CANVAS
   ===================================================== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

const container = document.getElementById('container');
const loader = document.getElementById('loader');
const barFill = document.getElementById('barFill');

let DPR = Math.min(2, window.devicePixelRatio || 1);
let W = 0, H = 0;

function resize(){
  const w = Math.min(window.innerWidth - 24, 960);
  const h = window.innerHeight - document.querySelector('header').offsetHeight - 24;

  const aspect = 3/2;
  let cssW = Math.min(w, h / aspect);
  let cssH = cssW * aspect;

  container.style.width = cssW + 'px';
  container.style.height = cssH + 'px';

  canvas.style.width = cssW + 'px';
  canvas.style.height = cssH + 'px';

  canvas.width = cssW * DPR;
  canvas.height = cssH * DPR;

  W = cssW / CAMERA_SCALE;
  H = cssH / CAMERA_SCALE;

  ctx.setTransform(DPR * CAMERA_SCALE,0,0,DPR * CAMERA_SCALE,0,0);
}
resize();
window.addEventListener('resize', resize);

/* =====================================================
   ASSET LOADER (ЕДИНСТВЕННЫЙ И ПРАВИЛЬНЫЙ)
   ===================================================== */
let ASSET_VER = '';

function assetUrl(name){
  return ASSET_VER ? `${name}?v=${ASSET_VER}` : name;
}

function loadImage(url){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=>resolve(img);
    img.onerror = ()=>reject(url);
    img.src = url;
  });
}

async function loadAssets(){
  const r = await fetch(MANIFEST_URL, { cache:'no-store' });
  if(!r.ok) throw 'manifest fail';

  const json = await r.json();
  ASSET_VER = json.version || Date.now();
  const files = json.assets;

  let loaded = 0;
  const out = {};

  for(const f of files){
    try{
      out[f] = await loadImage(assetUrl(f));
    }catch(e){
      alert('НЕ НАЙДЕН ФАЙЛ:\n' + e);
      throw e;
    }
    loaded++;
    barFill.style.width = Math.round(loaded/files.length*100)+'%';
  }
  return out;
}

/* =====================================================
   GAME ASSETS
   ===================================================== */
let IMG = {};

const FLOOR_TYPES = [
  { id:'A', prefix:'TipA-', n:2, w:155, h:121 },
  { id:'B', prefix:'TipB-', n:3, w:190, h:149 },
  { id:'C', prefix:'TipC-', n:2, w:116, h:186 },
  { id:'D', prefix:'TipD-', n:4, w:100, h:100 },
  { id:'F', prefix:'TipF-', n:3, w:119, h:205 }
];

const FLOOR_IMG = {};

/* =====================================================
   GAME (МИНИМАЛЬНО, НО СТАБИЛЬНО)
   ===================================================== */
let blocks = [];
let cur = null;
let dir = 1;
let speed = 2.5;
let dropping = false;

function spawn(){
  const t = FLOOR_TYPES[Math.floor(Math.random()*FLOOR_TYPES.length)];
  const imgs = FLOOR_IMG[t.id];
  const img = imgs[Math.floor(Math.random()*imgs.length)];

  cur = {
    x: dir>0 ? -t.w : W,
    y: blocks.length ? blocks[blocks.length-1].y - t.h - 40 : H - t.h,
    w:t.w,
    h:t.h,
    img
  };
  dir *= -1;
}

function update(){
  ctx.clearRect(0,0,W,H);

  for(const b of blocks){
    ctx.drawImage(b.img,b.x,b.y,b.w,b.h);
  }

  if(cur){
    if(!dropping){
      cur.x += speed * dir;
      if(cur.x<0 || cur.x+cur.w>W) dir*=-1;
    }else{
      cur.y += 6;
      const last = blocks[blocks.length-1];
      if(!last || cur.y+cur.h>=last.y){
        cur.y = last ? last.y-cur.h : cur.y;
        blocks.push(cur);
        cur=null;
        dropping=false;
        spawn();
      }
    }
    ctx.drawImage(cur.img,cur.x,cur.y,cur.w,cur.h);
  }

  requestAnimationFrame(update);
}

canvas.addEventListener('pointerdown',()=>{
  if(cur && !dropping) dropping=true;
});

/* =====================================================
   BOOT
   ===================================================== */
(async ()=>{
  try{
    IMG = await loadAssets();

    for(const t of FLOOR_TYPES){
      FLOOR_IMG[t.id]=[];
      for(let i=1;i<=t.n;i++){
        FLOOR_IMG[t.id].push(IMG[`${t.prefix}${i}.webp`]);
      }
    }

    loader.remove();
    spawn();
    update();
  }catch(e){
    console.error(e);
  }
})();
</script>
</body>
</html>
